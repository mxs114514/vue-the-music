# 歌词功能开发文档

## 第一章：界面UI与基础架构实现

### 1. 全局状态管理 (Pinia)
**文件**: `src/stores/player.ts`

在 Player Store 中增加了控制歌词页显示的状态：
- **State**: `isLyricsPageOpen` (boolean)
- **Action**: `toggleLyricsPage()` 用于切换开关状态。

### 2. 歌词页组件结构
**文件**: `src/components/business/LyricsPage.vue`

- **布局**: 使用 `position: fixed` 全屏定位。
- **层级**: `z-index: 90`，位于主内容之上，但低于底部播放栏 (`z-index: 100`)。
- **交互**: 顶部包含关闭按钮，点击调用 Store 关闭页面。
- **样式**: 底部留出 `80px` 空间，避免遮挡播放栏。

### 3. 布局集成与动画
**文件**: `src/components/layout/BasicLayout.vue`

- **集成**: 在 `AppFooterPlayerBar` 之前引入 `LyricsPage` 组件。
- **动画**: 使用 Vue `<Transition name="slide-up">` 包裹组件。
- **CSS**: 定义了 `.slide-up-enter-active` 等类，实现从底部滑入/滑出的效果 (`transform: translateY(100%)`)。

### 4. 触发入口
**文件**: `src/components/layout/AppFooterPlayerBar.vue`

- **触发**: 在底部播放栏的封面图片区域添加点击事件。
- **实现**: 使用 `div.cover-wrapper` 包裹图片，绑定 `@click="playerStore.toggleLyricsPage"`。
- **反馈**: 添加 `cursor: pointer` 样式，鼠标悬停显示手型。

---

## 第二章：歌词核心逻辑与交互实现

### 1. 功能概述
实现了一个全屏歌词界面，具备以下核心特性：
- **LRC 解析**：支持标准 `[mm:ss.xx]` 格式解析。
- **精准同步**：基于播放时间的高性能歌词定位（二分查找）。
- **平滑滚动**：当前歌词始终保持在视图中心。
- **视觉聚焦**：通过 CSS 遮罩实现“中间高亮、两端渐隐”的聚光灯效果。
- **双向交互**：点击歌词可直接跳转播放进度（Seek）。

### 2. 核心实现思路

#### 2.1 数据流转
1.  **获取**：监听 `currentSong` 变化 -> `fetch(lrcUrl)` 获取文本。
2.  **解析**：使用正则 `/^\[(\d{2}):(\d{2})\.(\d{2,3})\](.*)$/` 将文本转换为 `LyricLine[]` 对象数组。
3.  **同步**：监听 `playerStore.currentTime` -> 计算 `currentLineIndex`。
4.  **渲染**：Vue 响应式更新 DOM -> `watch(currentLineIndex)` 触发滚动。

#### 2.2 关键算法：二分查找 (Binary Search)
为了在频繁触发的 `timeupdate` 事件中保持高性能，我们将查找当前歌词的算法从 O(n) 遍历优化为 O(log n) 二分查找。

**代码实现 (`src/components/business/LyricsPage.vue`)**:
```typescript
// 查找最后一个 time <= newTime 的元素
let l = 0, r = lyrics.value.length - 1
while (l <= r) {
  const mid = Math.floor((l + r) / 2)
  if (lyrics.value[mid].time <= newTime) {
    index = mid
    l = mid + 1
  } else {
    r = mid - 1
  }
}
```

#### 2.3 视觉实现：CSS 遮罩 (Masking)
为了实现“页面中间始终最多只有10句，两端渐隐”的效果，我们摒弃了复杂的 JS 计算透明度方案，转而使用 CSS `mask-image`。

**原理**：
利用线性渐变定义遮罩层的透明度通道。黑色部分可见，透明部分不可见。

**代码实现**:
```css
.lyrics-container {
  /* 20%-80% 区域可见，两端渐隐 */
  mask-image: linear-gradient(
    to bottom,
    transparent 0%,
    transparent 20%,
    black 30%,
    black 70%,
    transparent 80%,
    transparent 100%
  );
}
```

#### 2.4 自动滚动逻辑
如何让当前高亮行始终居中？
公式：`scrollTop = 当前行.offsetTop - (容器高度 / 2) + (行高/2)`

**注意点**：必须使用 `await nextTick()` 确保 DOM 类名更新（字体变大）导致的高度变化完成后再计算。

### 3. 踩坑与调试记录

#### 3.1 坑一：滚动不生效
**现象**：歌词高亮了，但容器不滚动。
**原因**：
1.  在 `<script setup>` 中忘记定义 `const lyricsContainerRef = ref(null)`，导致模板引用失败。
2.  CSS 中没有设置 `position: relative`，导致 `offsetTop` 计算不准。
**解决**：补全 ref 定义，并确保容器有定位上下文。

#### 3.2 坑二：点击歌词跳转无效
**现象**：点击歌词，`playerStore.currentTime` 变了，但音乐进度没变。
**原因**：数据流是单向的（Audio -> Store）。修改 Store 不会自动反向控制 Audio 元素。
**解决**：在 `AppFooterPlayerBar.vue` 中添加监听：
```typescript
watch(currentTime, (newVal) => {
  // 阈值判断，防止 timeupdate 循环触发
  if (Math.abs(audio.currentTime - newVal) > 0.5) {
    audio.currentTime = newVal
  }
})
```

#### 3.3 坑三：CSS 语法错误
**现象**：Vite 报错 `Unknown word .lyric-line.`。
**原因**：在使用 AI 辅助编辑时，替换字符串操作不当，导致 CSS 文件中残留了乱码（如 `.lyric-line.;`）。
**解决**：手动清理 CSS，保持结构清晰。

#### 3.4 坑四：布局间距调整
**需求**：希望 CD 和歌词靠得更近。
**调试**：
最初尝试用 `justify-content: center`，但两者间距过大。
最终方案采用**不对称 Padding**：
- 左侧 CD 容器：`justify-content: flex-end; padding-right: 80px;`
- 右侧歌词容器：`padding-left: 20px; padding-right: 140px;`
这样在视觉上强制拉近了两者距离，同时保持了整体平衡。

### 4. 最终效果清单
- [x] 歌词解析与渲染
- [x] CD 旋转动画（随播放状态启停）
- [x] 二分查找高频同步
- [x] 智能居中滚动
- [x] CSS 渐隐遮罩（聚光灯效果）
- [x] 点击歌词跳转进度
- [x] 移动端响应式适配
