# 修改个人信息功能实现总结

本文档详细记录了“个人中心-修改个人信息”功能的从零实现过程，包括需求分析、后端开发、前端开发、踩坑修复以及最终的代码重构。

## 1. 需求与思路分析

### 目标
实现用户修改个人资料（头像、昵称、简介、性别、生日、地区），并确保数据在前后端正确同步。

### 核心难点与决策
1.  **身份识别**：如何确保只能修改自己的信息？
    *   **决策**：使用 JWT (JSON Web Token)。前端在请求头携带 `Authorization: Bearer <token>`，后端通过中间件解析出 `userId`。
2.  **头像存储**：
    *   **决策**：开发阶段采用本地存储。使用 `multer` 中间件将文件存入 `server/public/avatars`，后端提供静态资源访问。
3.  **数据格式差异**：
    *   **地区 (`region`)**：前端级联选择器使用数组 `['广东省', '深圳市']`，后端数据库存储字符串 `"广东省 深圳市"`。需要双向转换。
    *   **生日 (`birthday`)**：前端使用 `YYYY-MM-DD` 字符串，后端 Prisma 使用 `DateTime` 对象。需要格式化处理。

---

## 2. 后端实现 (Node.js + Express + Prisma)

### 2.1 鉴权中间件 (`auth.middleware.ts`)
为了在 Request 对象中安全地获取用户信息，我们实现了 JWT 验证中间件。
*   **关键点**：使用 `declare global` 扩展 Express 的 `Request` 类型，添加 `user` 属性。
*   **踩坑**：TS 报 `ES2015 module syntax is preferred over namespaces`。
    *   **解决**：这是 TS 扩展第三方库类型的标准写法，添加 `// eslint-disable-next-line` 忽略该规则。

### 2.2 用户控制器 (`user.controller.ts`)
*   **`getProfile`**：返回当前用户信息（排除密码）。
*   **`updateProfile`**：
    *   检查用户名唯一性（如果修改了用户名）。
    *   处理 `birthday`：字符串转 `Date` 对象。
    *   处理 `region`：直接存字符串。
*   **`handleAvatarUpload`**：配合 `multer`，返回上传后的相对路径 `/avatars/xxx.jpg`。

### 2.3 静态资源配置 (`index.ts`)
为了让前端能访问上传的头像，必须开启静态文件服务：
```typescript
app.use(express.static('public'))
```

---

## 3. 前端实现 (Vue 3 + Pinia + Element Plus)

### 3.1 初始实现 (EditProfileView.vue)
最初我们将所有逻辑写在一个组件里：
*   使用 `el-upload` 上传头像。
*   使用 `el-form` 绑定数据。
*   直接在组件内调用 `request.put`。

### 3.2 关键配置 (`vite.config.ts`)
*   **问题**：后端返回头像路径 `/avatars/xxx.jpg`，前端访问 `http://localhost:5173/avatars/...` 报 404。
*   **解决**：配置 Vite 代理，将 `/avatars` 转发到后端端口。
```typescript
proxy: {
  '/api': { target: 'http://localhost:3000', changeOrigin: true },
  '/avatars': { target: 'http://localhost:3000', changeOrigin: true }
}
```

---

## 4. 踩坑与修复记录 (Troubleshooting)

### 4.1 异步操作缺失 await
*   **现象**：点击保存后，立即提示成功并跳转，但后端可能还没处理完，或者报错了用户不知道。
*   **原因**：`request.put` 是异步的，但没加 `await`。
*   **修复**：
    ```typescript
    // 错误
    request.put(...)
    router.back()
    
    // 正确
    await request.put(...)
    router.back()
    ```

### 4.2 API 路径重复
*   **现象**：请求发往 `/api/api/user/profile`，导致 404。
*   **原因**：`request` 工具类已配置 `baseURL: '/api'`，组件调用时又写了 `/api/user/profile`。
*   **修复**：组件调用改为 `/user/profile`。

### 4.3 生日格式显示异常
*   **现象**：日期选择器显示 ISO 时间 `2005-06-28T00:00:00.000Z`。
*   **原因**：后端返回的是 UTC 时间字符串。
*   **修复**：初始化表单时截取日期部分。
    ```typescript
    birthday: user.birthday ? String(user.birthday).split('T')[0] : ''
    ```

---

## 5. 代码重构 (Refactoring) —— 最佳实践

为了解决 `EditProfileView.vue` 代码臃肿、职责不清的问题，我们进行了重构。

### 5.1 逻辑下沉 (Store)
将 API 调用移入 `src/stores/auth.ts`。
*   新增 `updateUserProfile(data)` Action。
*   **好处**：组件不需要关心 HTTP 请求细节，且更新成功后 Store 自动刷新本地数据。

### 5.2 组件拆分
1.  **`AvatarUploader.vue`**：
    *   封装头像上传、校验、回显逻辑。
    *   使用 `v-model` 实现双向绑定。
2.  **`ProfileEditForm.vue`**：
    *   封装表单字段和布局。
    *   **内部处理数据转换**：组件内部处理 `region` 的数组/字符串转换，对外暴露干净的数据接口。

### 5.3 容器组件化
现在的 `EditProfileView.vue` 变成了纯粹的**容器组件**：
```vue
<template>
  <div class="edit-profile-view">
    <ProfileEditForm 
      :initial-user="authStore.user"
      @submit="handleSave"
      @cancel="handleCancel"
    />
  </div>
</template>
```

---

## 6. 最终文件清单

### 后端
*   `server/src/middleware/auth.middleware.ts` (鉴权)
*   `server/src/controllers/user.controller.ts` (业务逻辑)
*   `server/src/routes/user.routes.ts` (路由)
*   `server/public/avatars/` (头像存储)

### 前端
*   `src/stores/auth.ts` (状态管理 & API)
*   `src/components/business/AvatarUploader.vue` (头像组件)
*   `src/components/business/ProfileEditForm.vue` (表单组件)
*   `src/views/EditProfileView.vue` (页面容器)
*   `vite.config.ts` (代理配置)