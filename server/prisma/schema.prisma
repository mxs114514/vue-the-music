// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client"
  output   = "./generated/client"
}

datasource db {
  provider = "sqlite"
}

// ...existing code...

model Song {
  id        Int      @id @default(autoincrement())
  title     String
  artist    String
  album     String? // 新增：专辑名称
  url       String
  cover     String?
  lrcUrl    String?
  duration  Int? // 歌曲时长（秒）
  size      Int      @default(0) // 新增：文件大小(字节)，用于统计存储占用
  playCount Int      @default(0) // 播放次数统计（冗余字段，用于快速排序）
  isDeleted Boolean  @default(false) // 软删除标记
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  playRecords PlayRecord[]
  favoritedBy Favorite[] // 新增：关联收藏记录，用于统计收藏数

  @@index([title])
  @@index([artist])
  @@index([createdAt])
  @@index([playCount]) // 用于“总热度榜”快速排序
  @@index([album])
}

model User {
  id        Int       @id @default(autoincrement())
  username  String    @unique
  nickname  String? // 用户昵称，用于显示
  password  String
  role      String    @default("user") // "admin" 或 "user"
  createdAt DateTime  @default(now())
  avatar    String? // 头像URL
  bio       String? // 简介
  gender    String? // 性别
  birthday  DateTime? // 生日
  region    String? // 地区

  playRecords PlayRecord[]
  favorites   Favorite[] // 新增：用户的收藏列表
}

// 新增：收藏/喜欢 中间表
model Favorite {
  id Int @id @default(autoincrement())

  user   User @relation(fields: [userId], references: [id])
  userId Int

  song   Song @relation(fields: [songId], references: [id])
  songId Int

  createdAt DateTime @default(now()) // 关键：收藏时间。用于生成“月度收藏榜”、“年度收藏榜”

  // 同时依然强制“一个用户对同一首歌只能收藏一次”
  @@unique([userId, songId])
  // 索引优化
  @@index([createdAt]) // 用于按时间范围筛选（月榜/年榜）
  @@index([songId]) // 用于统计某首歌的收藏总数
  @@index([userId]) // 用于查询某人的收藏列表
}

model PlayRecord {
  id       Int      @id @default(autoincrement())
  playedAt DateTime @default(now())

  // 关联歌曲
  song   Song @relation(fields: [songId], references: [id])
  songId Int

  // 关联用户（记录是谁播放的）
  user   User? @relation(fields: [userId], references: [id])
  userId Int?

  @@index([playedAt]) // 用于“月度榜单”按时间筛选
  @@index([songId])
  @@index([userId])
}
